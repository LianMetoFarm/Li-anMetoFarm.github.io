<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Kandang Ayam</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.css"/>
    <!-- DashUI CSS -->
    <link href="https://unpkg.com/dashui@1.0.0/dist/dashui.min.css" rel="stylesheet">
    <style>
        .chart-container {
            position: relative;
            margin-top: 20px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

<div id="app">
    <div class="container">
        <h1 class="my-4">Data Kandang 2</h1>
        <div class="table-responsive" id="data-container"></div>
    </div>
    <div class="container">
        <h2 class="my-4 text-center">Informasi Grafik</h2>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="row mt-3">
                    <div class="col-md-3">
                        <p>Total Ayam Masuk : <span id="totalAyam"></span></p>
                    </div>
                    <div class="col-md-3">
                        <p>Total Ayam Mati : <span id="totalAyamMati"></span></p>
                    </div>
                    <div class="col-md-3">
                        <p>Total Ayam Afkir : <span id="totalAyamAfkir"></span></p>
                    </div>
                    <div class="col-md-3">
                        <p>Total Sisa Ayam : <span id="totalSisaAyam"></span></p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row mt-8">
                    <div class="col-md-4">
                        <p>Total Rak Utuh : <span id="totalRakUtuh"></span></p>
                        <p>Total Butir Utuh : <span id="totalButirUtuh"></span></p>
                    </div>
                    <div class="col-md-4">
                        <p>Total Rak Retak : <span id="totalRakRetak"></span></p>
                        <p>Total Butir Retak : <span id="totalButirRetak"></span></p>
                    </div>
                    <div class="col-md-4">
                        <p>Total Rak Pecah : <span id="totalRakPecah"></span></p>
                        <p>Total Butir Pecah : <span id="totalButirPecah"></span></p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<!-- VueJS -->
<script src="https://unpkg.com/vue@3.2.21"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    Vue.createApp({
        data() {
            return {
                // API key untuk Google Sheets API
                apiKey: 'AIzaSyBJ52mawoRgwYjQd9kPjx0gIwjvFlX4Ysc',
                // ID dari spreadsheet
                spreadsheetId: '1Rw9tiukS0x95xo1wisWOTLCYKt96QDC2RTf1uoxy_DM',
                // Daftar nama sheet yang ingin diambil
                sheetNames: ['Kandang 2'],
                // Kolom yang ingin ditampilkan (indeks dimulai dari 0)
                columnsToDisplay: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17], // Kolom A (0), B (1), dan E (4)
                columnTitles: ['Id', 'Tanggal', 'Minggu', 'Umur', 'Ayam Mati', 'Ayam Afkir', 'Sisa Ayam', 'Rak Utuh', 'Butir Utuh', 'Rak Retak', 'Butir Retak', 'Rak Pecah', 'Butir Pecah', 'HD%', 'HH%', 'Pakan', 'Intek', 'Keteragan'], // Judul Kolom
                monthlyData: {},
            };
        },
        mounted() {
            this.getData();
        },
        methods: {
            getData() {
                // Endpoint API untuk mendapatkan metadata tentang spreadsheet
                const baseUrl = 'https://sheets.googleapis.com/v4/spreadsheets/';
                const url = baseUrl + this.spreadsheetId + '?key=' + this.apiKey;

                // Ambil metadata tentang spreadsheet
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const sheets = data.sheets;

                        // Loop melalui setiap sheet
                        for (let i = 0; i < sheets.length; i++) {
                            const sheet = sheets[i];
                            const sheetTitle = sheet.properties.title;

                            // Jika sheet ada dalam daftar yang diinginkan
                            if (this.sheetNames.includes(sheetTitle)) {
                                const sheetId = sheet.properties.sheetId;

                                // Endpoint API untuk mendapatkan data dari sheet tertentu
                                const range = sheetTitle + '!A11:U100';
                                const sheetUrl = baseUrl + this.spreadsheetId + '/values/' + range + '?key=' + this.apiKey;

                                // Ambil data dari sheet
                                fetch(sheetUrl)
                                    .then(response => response.json())
                                    .then(sheetData => {
                                        if (sheetData && sheetData.values && sheetData.values.length > 0) {
                                            const rows = sheetData.values;

                                            // Tambahkan data ke dalam tabel menggunakan DataTables
                                            document.getElementById('data-container').innerHTML = '<table id="data-table" class="table table-striped text-success table-border"></table>';
                                            $(document).ready(function () {
                                                $('#data-table').DataTable({
                                                    data: rows,
                                                    columns: this.columnTitles.map(title => ({ title: title }))
                                                });
                                            });

                                            // Menghitung total ayam
                                            const totalAyam = parseInt(rows[0][6] || 0);

                                            // Menghitung total ayam mati dan total ayam afkir
                                            const totalAyamMati = rows.reduce((total, row) => total + parseInt(row[4] || 0), 0);
                                            const totalAyamAfkir = rows.reduce((total, row) => total + parseInt(row[5] || 0), 0);

                                            // Menghitung total sisa ayam
                                            const totalSisaAyam = parseInt(rows[0][6] || 0) - totalAyamMati - totalAyamAfkir;

                                            // Menghitung total per bulan untuk grafik batang
                                            rows.forEach(row => {
                                                const date = new Date(row[1]);
                                                const year = date.getFullYear();
                                                const month = date.getMonth() + 1; // Ambil bulan dari kolom kedua (tanggal) dan tambahkan 1 karena bulan dimulai dari 0
                                                const label = year + '-' + (month < 10 ? '0' + month : month); // Format label bulan dengan tahun (misalnya, 2022-01)
                                                if (!this.monthlyData[label]) {
                                                    this.monthlyData[label] = {
                                                        totalRakUtuh: 0,
                                                        totalButirUtuh: 0,
                                                        totalRakRetak: 0,
                                                        totalButirRetak: 0,
                                                        totalRakPecah: 0,
                                                        totalButirPecah: 0
                                                    };
                                                }
                                                this.monthlyData[label].totalRakUtuh += parseInt(row[7] || 0);
                                                this.monthlyData[label].totalButirUtuh += parseInt(row[8] || 0);
                                                this.monthlyData[label].totalRakRetak += parseInt(row[9] || 0);
                                                this.monthlyData[label].totalButirRetak += parseInt(row[10] || 0);
                                                this.monthlyData[label].totalRakPecah += parseInt(row[11] || 0);
                                                this.monthlyData[label].totalButirPecah += parseInt(row[12] || 0);
                                            });

                                            // Menghitung total Rak Utuh, Butir Utuh, Rak Retak, Butir Retak, Rak Pecah, dan Butir Pecah
                                            const totalRakUtuh = Object.values(this.monthlyData).reduce((total, data) => total + data.totalRakUtuh, 0);
                                            const totalButirUtuh = Object.values(this.monthlyData).reduce((total, data) => total + data.totalButirUtuh, 0);
                                            const totalRakRetak = Object.values(this.monthlyData).reduce((total, data) => total + data.totalRakRetak, 0);
                                            const totalButirRetak = Object.values(this.monthlyData).reduce((total, data) => total + data.totalButirRetak, 0);
                                            const totalRakPecah = Object.values(this.monthlyData).reduce((total, data) => total + data.totalRakPecah, 0);
                                            const totalButirPecah = Object.values(this.monthlyData).reduce((total, data) => total + data.totalButirPecah, 0);

                                            // Menampilkan total ayam mati, total ayam afkir, total sisa ayam, total rak utuh, total butir utuh, total rak retak, total butir retak, total rak pecah, dan total butir pecah dengan animasi
                                            $('#totalAyam').prop('Counter', 0).animate({
                                                Counter: totalAyam
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalAyamMati').prop('Counter', 0).animate({
                                                Counter: totalAyamMati
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalAyamAfkir').prop('Counter', 0).animate({
                                                Counter: totalAyamAfkir
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalSisaAyam').prop('Counter', 0).animate({
                                                Counter: totalSisaAyam
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalRakUtuh').prop('Counter', 0).animate({
                                                Counter: totalRakUtuh
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalButirUtuh').prop('Counter', 0).animate({
                                                Counter: totalButirUtuh
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalRakRetak').prop('Counter', 0).animate({
                                                Counter: totalRakRetak
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalButirRetak').prop('Counter', 0).animate({
                                                Counter: totalButirRetak
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalRakPecah').prop('Counter', 0).animate({
                                                Counter: totalRakPecah
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });
                                            $('#totalButirPecah').prop('Counter', 0).animate({
                                                Counter: totalButirPecah
                                            }, {
                                                duration: 1000,
                                                easing: 'swing',
                                                step: function (now) {
                                                    $(this).text(Math.ceil(now));
                                                }
                                            });

                                            // Tambahkan grafik pie
                                            const pieChartCanvas = document.getElementById('pieChart');
                                            const pieChartData = {
                                                labels: ['Ayam Mati', 'Ayam Afkir'],
                                                datasets: [{
                                                    label: 'Ayam',
                                                    data: [totalAyamMati, totalAyamAfkir],
                                                    backgroundColor: [
                                                        'rgba(255, 99, 132, 0.2)',
                                                        'rgba(54, 162, 235, 0.2)'
                                                    ],
                                                    borderColor: [
                                                        'rgba(255, 99, 132, 1)',
                                                        'rgba(54, 162, 235, 1)'
                                                    ],
                                                    borderWidth: 1
                                                }]
                                            };
                                            const pieChartOptions = {
                                                scales: {
                                                    y: {
                                                        beginAtZero: true
                                                    }
                                                }
                                            };
                                            new Chart(pieChartCanvas, {
                                                type: 'pie',
                                                data: pieChartData,
                                                options: pieChartOptions
                                            });

                                            // Tambahkan grafik bar
                                            const barChartCanvas = document.getElementById('barChart');
                                            const barChartData = {
                                                labels: Object.keys(this.monthlyData), // Label bulan dengan tahun (misalnya, 2022-01)
                                                datasets: [
                                                    {
                                                        label: 'Rak Utuh',
                                                        data: Object.values(this.monthlyData).map(data => data.totalRakUtuh),
                                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                                        borderColor: 'rgba(255, 99, 132, 1)',
                                                        borderWidth: 1
                                                    },
                                                    {
                                                        label: 'Butir Utuh',
                                                        data: Object.values(this.monthlyData).map(data => data.totalButirUtuh),
                                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                                        borderColor: 'rgba(54, 162, 235, 1)',
                                                        borderWidth: 1
                                                    },
                                                    {
                                                        label: 'Rak Retak',
                                                        data: Object.values(this.monthlyData).map(data => data.totalRakRetak),
                                                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                                        borderColor: 'rgba(255, 206, 86, 1)',
                                                        borderWidth: 1
                                                    },
                                                    {
                                                        label: 'Butir Retak',
                                                        data: Object.values(this.monthlyData).map(data => data.totalButirRetak),
                                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                                        borderColor: 'rgba(75, 192, 192, 1)',
                                                        borderWidth: 1
                                                    },
                                                    {
                                                        label: 'Rak Pecah',
                                                        data: Object.values(this.monthlyData).map(data => data.totalRakPecah),
                                                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                                        borderColor: 'rgba(153, 102, 255, 1)',
                                                        borderWidth: 1
                                                    },
                                                    {
                                                        label: 'Butir Pecah',
                                                        data: Object.values(this.monthlyData).map(data => data.totalButirPecah),
                                                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                                        borderColor: 'rgba(255, 159, 64, 1)',
                                                        borderWidth: 1
                                                    }
                                                ]
                                            };
                                            const barChartOptions = {
                                                scales: {
                                                    y: {
                                                        beginAtZero: true
                                                    }
                                                }
                                            };
                                            new Chart(barChartCanvas, {
                                                type: 'bar',
                                                data: barChartData,
                                                options: barChartOptions
                                            });
                                        } else {
                                            console.log('Data tidak tersedia atau tidak valid.');
                                        }
                                    })
                                    .catch(() => {
                                        console.log('Gagal mengambil data dari spreadsheet.');
                                    });
                            }
                        }
                    })
                    .catch(() => {
                        console.log('Gagal mengambil metadata tentang spreadsheet.');
                    });
            }
        }
    }).mount('#app');
</script>

</body>
</html>