<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Kandang Ayam</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.css"/>
    <style>
        .chart-container {
            position: relative;
            margin-top: 20px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="my-4">Data Kandang 2</h1>
    <div class="table-responsive" id="data-container"></div>
</div>
<div class="container">
    <h2 class="my-4 text-center">Informasi Grafik</h2>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="row mt-3">
                <div class="col-md-3">
                    <p>Total Ayam Masuk : <span id="totalAyam"></span></p>
                </div>
                <div class="col-md-3">
                    <p>Total Ayam Mati : <span id="totalAyamMati"></span></p>
                </div>
                <div class="col-md-3">
                    <p>Total Ayam Afkir : <span id="totalAyamAfkir"></span></p>
                </div>
                <div class="col-md-3">
                    <p>Total Sisa Ayam : <span id="totalSisaAyam"></span></p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row mt-8">
                <div class="col-md-4">
                    <p>Total Rak Utuh : <span id="totalRakUtuh"></span></p>
                    <p>Total Butir Utuh : <span id="totalButirUtuh"></span></p>
                </div>
                <div class="col-md-4">
                    <p>Total Rak Retak : <span id="totalRakRetak"></span></p>
                    <p>Total Butir Retak : <span id="totalButirRetak"></span></p>
                </div>
                <div class="col-md-4">
                    <p>Total Rak Pecah : <span id="totalRakPecah"></span></p>
                    <p>Total Butir Pecah : <span id="totalButirPecah"></span></p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- DataTables -->
<script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function() {
        // API key untuk Google Sheets API
        var apiKey = 'AIzaSyBJ52mawoRgwYjQd9kPjx0gIwjvFlX4Ysc';
        // ID dari spreadsheet
        var spreadsheetId = '1Rw9tiukS0x95xo1wisWOTLCYKt96QDC2RTf1uoxy_DM';

        // Daftar nama sheet yang ingin diambil
        var sheetNames = ['Kandang 2'];

        // Kolom yang ingin ditampilkan (indeks dimulai dari 0)
        var columnsToDisplay = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17]; // Kolom A (0), B (1), dan E (4)
        var columnTitles = ['Id', 'Tanggal', 'Minggu', 'Umur', 'Ayam Mati', 'Ayam Afkir', 'Sisa Ayam', 'Rak Utuh', 'Butir Utuh', 'Rak Retak', 'Butir Retak', 'Rak Pecah', 'Butir Pecah', 'HD%', 'HH%', 'Pakan', 'Intek', 'Keteragan']; // Judul Kolom

        // Endpoint API untuk mendapatkan metadata tentang spreadsheet
        var baseUrl = 'https://sheets.googleapis.com/v4/spreadsheets/';
        var url = baseUrl + spreadsheetId + '?key=' + apiKey;

        // Ambil metadata tentang spreadsheet
        $.get(url, function(data) {
            var sheets = data.sheets;

            // Loop melalui setiap sheet
            for (var i = 0; i < sheets.length; i++) {
                var sheet = sheets[i];
                var sheetTitle = sheet.properties.title;

                // Jika sheet ada dalam daftar yang diinginkan
                if (sheetNames.includes(sheetTitle)) {
                    var sheetId = sheet.properties.sheetId;

                    // Endpoint API untuk mendapatkan data dari sheet tertentu
                    var range = sheetTitle + '!A11:U100';
                    var sheetUrl = baseUrl + spreadsheetId + '/values/' + range + '?key=' + apiKey;

                    // Ambil data dari sheet
                    $.get(sheetUrl, function(sheetData) {
                        if (sheetData && sheetData.values && sheetData.values.length > 0) {
                            var rows = sheetData.values;

                            // Tambahkan data ke dalam tabel menggunakan DataTables
                            $('#data-container').html('<table id="data-table" class="table table-striped text-success table-border"></table>');
                            $('#data-table').DataTable({
                                data: rows,
                                columns: columnTitles.map(title => ({title: title}))
                            });

                            // Hitung total ayam
                            var totalAyam = parseInt(rows[0][6] || 0);

                            // Hitung total ayam mati dan total ayam afkir
                            var totalAyamMati = rows.reduce((total, row) => total + parseInt(row[4] || 0), 0);
                            var totalAyamAfkir = rows.reduce((total, row) => total + parseInt(row[5] || 0), 0);

                            // Hitung total sisa ayam
                            var totalSisaAyam = parseInt(rows[0][6] || 0) - totalAyamMati - totalAyamAfkir;

                            // Hitung total per bulan untuk grafik batang
                            var monthlyData = {};
                            rows.forEach(function(row) {
                                var month = new Date(row[1]).getMonth() + 1; // Ambil bulan dari kolom kedua (tanggal) dan tambahkan 1 karena bulan dimulai dari 0
                                if (!monthlyData[month]) {
                                    monthlyData[month] = {
                                        totalRakUtuh: 0,
                                        totalButirUtuh: 0,
                                        totalRakRetak: 0,
                                        totalButirRetak: 0,
                                        totalRakPecah: 0,
                                        totalButirPecah: 0
                                    };
                                }
                                monthlyData[month].totalRakUtuh += parseInt(row[7] || 0);
                                monthlyData[month].totalButirUtuh += parseInt(row[8] || 0);
                                monthlyData[month].totalRakRetak += parseInt(row[9] || 0);
                                monthlyData[month].totalButirRetak += parseInt(row[10] || 0);
                                monthlyData[month].totalRakPecah += parseInt(row[11] || 0);
                                monthlyData[month].totalButirPecah += parseInt(row[12] || 0);
                            });

                            // Tambahkan grafik pie
                            var pieChartCanvas = document.getElementById('pieChart');
                            var pieChartData = {
                                labels: ['Ayam Mati', 'Ayam Afkir'],
                                datasets: [{
                                    label: 'Ayam',
                                    data: [totalAyamMati, totalAyamAfkir],
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.2)',
                                        'rgba(54, 162, 235, 0.2)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(54, 162, 235, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            };
                            var pieChartOptions = {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            };
                            new Chart(pieChartCanvas, {
                                type: 'pie',
                                data: pieChartData,
                                options: pieChartOptions
                            });

                            // Tambahkan grafik bar
                            var barChartCanvas = document.getElementById('barChart');
                            var barChartData = {
                                labels: Object.keys(monthlyData).map(month => 'Bulan ' + month), // Ubah label ke format 'Bulan 1', 'Bulan 2', ...
                                datasets: [
                                    {
                                        label: 'Rak Utuh',
                                        data: Object.values(monthlyData).map(data => data.totalRakUtuh),
                                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Butir Utuh',
                                        data: Object.values(monthlyData).map(data => data.totalButirUtuh),
                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Rak Retak',
                                        data: Object.values(monthlyData).map(data => data.totalRakRetak),
                                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                        borderColor: 'rgba(255, 206, 86, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Butir Retak',
                                        data: Object.values(monthlyData).map(data => data.totalButirRetak),
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Rak Pecah',
                                        data: Object.values(monthlyData).map(data => data.totalRakPecah),
                                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                        borderColor: 'rgba(153, 102, 255, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Butir Pecah',
                                        data: Object.values(monthlyData).map(data => data.totalButirPecah),
                                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                        borderColor: 'rgba(255, 159, 64, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            };
                            var barChartOptions = {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            };
                            var barChart = new Chart(barChartCanvas, {
                                type: 'bar',
                                data: barChartData,
                                options: barChartOptions
                            });

                            barChart.update();
                        } else {
                            console.log('Data tidak tersedia atau tidak valid.');
                        }
                    }).fail(function() {
                        console.log('Gagal mengambil data dari spreadsheet.');
                    });
                }
            }
        }).fail(function() {
            console.log('Gagal mengambil metadata tentang spreadsheet.');
        });
    });
</script>

</body>
</html>