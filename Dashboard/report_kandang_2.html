<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Kandang Ayam</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.css"/>
    <!-- Chart.js CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0-alpha0/chart.min.css">
    <style>
        .chart-container {
            position: relative;
            margin-top: 20px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        .my-card {
            border: none;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .my-card-header {
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }
        .my-card-body {
            padding: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="my-4">Data Kandang 2</h1>
    <div class="table-responsive my-card">
        <div class="my-card-body" id="data-container"></div>
    </div>
</div>

<div class="container mt-5">
    <h2 class="text-center">Informasi Grafik</h2>
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="my-card">
                <div class="my-card-header">
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <p>Total Ayam Masuk : <span id="totalAyam"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p>Total Ayam Mati : <span id="totalAyamMati"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p>Total Ayam Afkir : <span id="totalAyamAfkir"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p>Total Sisa Ayam : <span id="totalSisaAyam"></span></p>
                        </div>
                    </div>
                </div>
                <div class="my-card-body">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="my-card">
                <div class="my-card-header">
                    <div class="row mt-8">
                        <div class="col-md-4">
                            <p>Total Rak Utuh : <span id="totalRakUtuh"></span></p>
                            <p>Total Butir Utuh : <span id="totalButirUtuh"></span></p>
                        </div>
                        <div class="col-md-4">
                            <p>Total Rak Retak : <span id="totalRakRetak"></span></p>
                            <p>Total Butir Retak : <span id="totalButirRetak"></span></p>
                        </div>
                        <div class="col-md-4">
                            <p>Total Rak Pecah : <span id="totalRakPecah"></span></p>
                            <p>Total Butir Pecah : <span id="totalButirPecah"></span></p>
                        </div>
                    </div>
                </div>
                <div class="my-card-body">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- DataTables -->
<script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0-alpha0/chart.min.js"></script>
<!-- Google Sheets API -->
<script src="https://apis.google.com/js/api.js"></script>
<script>
    class ChartGenerator {
        constructor(canvasId, chartType, chartData, chartOptions) {
            this.canvas = document.getElementById(canvasId);
            this.chart = new Chart(this.canvas, {
                type: chartType,
                data: chartData,
                options: chartOptions
            });
        }

        updateChartData(newData) {
            this.chart.data.datasets.forEach((dataset, index) => {
                dataset.data = newData[index];
            });
            this.chart.update();
        }
    }

    $(document).ready(function() {
        var apiKey = 'YOUR_API_KEY';
        var spreadsheetId = 'YOUR_SPREADSHEET_ID';
        var sheetNames = ['Kandang 2'];
        var baseUrl = 'https://sheets.googleapis.com/v4/spreadsheets/';
        var url = baseUrl + spreadsheetId + '?key=' + apiKey;

        gapi.load('client', function() {
            gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            }).then(function() {
                return gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: spreadsheetId
                });
            }).then(function(response) {
                var sheets = response.result.sheets;
                for (var i = 0; i < sheets.length; i++) {
                    var sheet = sheets[i];
                    var sheetTitle = sheet.properties.title;
                    if (sheetNames.includes(sheetTitle)) {
                        var sheetId = sheet.properties.sheetId;
                        var range = sheetTitle + '!A11:U100';
                        var sheetUrl = baseUrl + spreadsheetId + '/values/' + range;
                        $.get(sheetUrl, function(sheetData) {
                            if (sheetData && sheetData.values && sheetData.values.length > 0) {
                                var rows = sheetData.values;

                                var totalAyam = parseInt(rows[0][6] || 0);
                                var totalAyamMati = rows.reduce((total, row) => total + parseInt(row[4] || 0), 0);
                                var totalAyamAfkir = rows.reduce((total, row) => total + parseInt(row[5] || 0), 0);
                                var totalSisaAyam = parseInt(rows[0][6] || 0) - totalAyamMati - totalAyamAfkir;
                                var totalRakUtuh = rows.reduce((total, row) => total + parseInt(row[7] || 0), 0);
                                var totalButirUtuh = rows.reduce((total, row) => total + parseInt(row[8] || 0), 0);
                                var totalRakRetak = rows.reduce((total, row) => total + parseInt(row[9] || 0), 0);
                                var totalButirRetak = rows.reduce((total, row) => total + parseInt(row[10] || 0), 0);
                                var totalRakPecah = rows.reduce((total, row) => total + parseInt(row[11] || 0), 0);
                                var totalButirPecah = rows.reduce((total, row) => total + parseInt(row[12] || 0), 0);
                                var averageRakUtuh = totalRakUtuh / rows.length;

                                $('#totalAyam').prop('Counter', 0).animate({
                                    Counter: totalAyam
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalAyamMati').prop('Counter', 0).animate({
                                    Counter: totalAyamMati
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalAyamAfkir').prop('Counter', 0).animate({
                                    Counter: totalAyamAfkir
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalSisaAyam').prop('Counter', 0).animate({
                                    Counter: totalSisaAyam
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalRakUtuh').prop('Counter', 0).animate({
                                    Counter: totalRakUtuh
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                }).append(' (Rata-rata: ' + averageRakUtuh.toFixed(2) + ')');
                                $('#totalButirUtuh').prop('Counter', 0).animate({
                                    Counter: totalButirUtuh
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalRakRetak').prop('Counter', 0).animate({
                                    Counter: totalRakRetak
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalButirRetak').prop('Counter', 0).animate({
                                    Counter: totalButirRetak
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalRakPecah').prop('Counter', 0).animate({
                                    Counter: totalRakPecah
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });
                                $('#totalButirPecah').prop('Counter', 0).animate({
                                    Counter: totalButirPecah
                                }, {
                                    duration: 1000,
                                    easing: 'swing',
                                    step: function(now) {
                                        $(this).text(Math.ceil(now));
                                    }
                                });

                                var pieChart = new ChartGenerator('pieChart', 'pie', {
                                    labels: ['Ayam Mati', 'Ayam Afkir'],
                                    datasets: [{
                                        label: 'Ayam',
                                        data: [totalAyamMati, totalAyamAfkir],
                                        backgroundColor: [
                                            'rgba(255, 99, 132, 0.2)',
                                            'rgba(54, 162, 235, 0.2)'
                                        ],
                                        borderColor: [
                                            'rgba(255, 99, 132, 1)',
                                            'rgba(54, 162, 235, 1)'
                                        ],
                                        borderWidth: 1
                                    }]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                });

                                var barChart = new ChartGenerator('barChart', 'bar', {
                                    labels: rows.map(row => row[1]),
                                    datasets: [
                                        {
                                            label: 'Rak Utuh',
                                            data: rows.map(row => parseInt(row[7])),
                                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                            borderColor: 'rgba(255, 99, 132, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Butir Utuh',
                                            data: rows.map(row => parseInt(row[8])),
                                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                            borderColor: 'rgba(54, 162, 235, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Rak Retak',
                                            data: rows.map(row => parseInt(row[9])),
                                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                            borderColor: 'rgba(255, 206, 86, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Butir Retak',
                                            data: rows.map(row => parseInt(row[10])),
                                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                            borderColor: 'rgba(75, 192, 192, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Rak Pecah',
                                            data: rows.map(row => parseInt(row[11])),
                                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                            borderColor: 'rgba(153, 102, 255, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Butir Pecah',
                                            data: rows.map(row => parseInt(row[12])),
                                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                            borderColor: 'rgba(255, 159, 64, 1)',
                                            borderWidth: 1
                                        }
                                    ]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                });

                                var eggProductionData = rows.map(row => parseInt(row[7]));
                                barChart.updateChartData([
                                    rows.map(row => parseInt(row[7])),
                                    rows.map(row => parseInt(row[8])),
                                    rows.map(row => parseInt(row[9])),
                                    rows.map(row => parseInt(row[10])),
                                    rows.map(row => parseInt(row[11])),
                                    rows.map(row => parseInt(row[12]))
                                ]);
                            } else {
                                console.log('Data tidak tersedia atau tidak valid.');
                            }
                        }).fail(function() {
                            console.log('Gagal mengambil data dari spreadsheet.');
                        });
                    }
                }
            });
        });
    });
</script>

</body>
</html>